<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
  <title>Dungeon Sketch</title>
  <link rel="stylesheet" href="style.css" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#f8f7f4" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
</head>
<body>
  <canvas></canvas>

  
  <div class="hud appShellHud">
    <header class="appTopbar" aria-label="Tools and actions">
      <div class="topbarTitle">Dungeon Sketch</div>

      <div class="toolbarShell" role="group" aria-label="Main toolbar">
        <div class="toolbarGroup toolbarTools" aria-label="Tools">
          <div class="toolbarHeader"><div class="toolbarLabel">Tools</div><button id="btnToggleToolsMenu" class="toolbarCollapseBtn" type="button" aria-expanded="true" aria-controls="toolbarToolsRow" title="Collapse tools menu">⟨</button></div>
          <div id="toolbarToolsRow" class="toolbarRow">
            <button class="tool" data-tool="select" title="Select/move/rotate props">Select</button>
            <button class="tool primary" data-tool="space" title="Rectangle (drag)">Rectangle</button>
            <button class="tool" data-tool="path" title="Path (tap points)">Path</button>
            <button class="tool" data-tool="free" title="Free path (draw)">Free</button>
            <button class="tool" data-tool="poly" title="Regular polygon">Polygon</button>
            <button class="tool" data-tool="text" title="Add text label">Text</button>
            <button class="tool" data-tool="erase" title="Toggle erase mode for the selected drawing tool">Erase</button>
          </div>
          <div id="polyToolOptions" class="toolSubrow hidden" aria-live="polite">
            <label class="toolInlineRange">
              <span>Polygon sides <strong id="polySidesOut">6</strong></span>
              <input id="polySides" type="range" min="3" max="12" step="1" value="6">
            </label>
          </div>
        </div>

        <div class="toolbarGroup toolbarActions" aria-label="Actions">
          <div class="toolbarHeader"><div class="toolbarLabel">Actions</div><button id="btnToggleActionsMenu" class="toolbarCollapseBtn" type="button" aria-expanded="true" aria-controls="toolbarActionsRow" title="Collapse actions menu">⟨</button></div>
          <div id="toolbarActionsRow" class="toolbarRow">
            <button id="btnUndo" title="Undo">⟲</button>
            <button id="btnRedo" title="Redo">⟳</button>
            <button id="btnClear" title="Clear all">Clear</button>
            <button id="btnSaveMap" title="Save map (.json)">Save</button>
            <button id="btnLoadMap" title="Load map (.json)">Load</button>
            <button id="btnExport" title="Export PNG">PNG</button>
            <button id="btnPDF" title="Export multipage PDF">PDF</button>
          </div>
        </div>
      </div>
</header>

    <div id="alphaBanner" class="alphaBanner" role="status" aria-live="polite">
      <div class="alphaBannerText">
        <strong>Alpha test warning:</strong> This app is in active testing. Features and behavior may change, and map save files may not be compatible with future versions.
      </div>
      <div class="alphaBannerActions">
        <button id="btnAlphaBannerClose" type="button" class="alphaBannerClose" aria-label="Dismiss alpha warning">✕</button>
      </div>
    </div>

    <div class="donateBanner" role="complementary" aria-label="Developer support">
      <a class="donateBannerLink" href="https://donate.stripe.com/4gM4gBcmO1nG9PA5zF1B601" target="_blank" rel="noopener noreferrer">Tip the developer</a>
    </div>

    <aside id="leftDrawer" class="leftDrawer" aria-label="Style, render, and assets">
      <div class="drawerCard">
        <div class="drawerHeader">
          <div class="drawerTitle">Style &amp; Render</div>
          <button id="btnDrawerCollapse" type="button" class="drawerMiniBtn" aria-expanded="true" aria-controls="leftDrawerBody" title="Collapse sidebar">⟨</button>
        </div>

        <div class="drawerTabs panelTabBar" role="tablist" aria-label="Sidebar tabs">
          <button id="tabStyleBtn" class="tabBtn primary" type="button" data-panel-tab="style" role="tab" aria-selected="true" aria-controls="styleRenderPage">Style &amp; Render</button>
          <button id="tabAssetsBtn" class="tabBtn" type="button" data-panel-tab="assets" role="tab" aria-selected="false" aria-controls="assetsPage">Assets</button>
        </div>

        <div id="leftDrawerBody" class="drawerBody">
          <div class="tabPanelsWrap">
            <section id="styleRenderPage" class="panelPage" data-panel-page="style" role="tabpanel">
              <div id="styleRenderGeneral" class="controls">
                <label>
                                    Grid size
                                    <input id="gridSize" type="range" min="16" max="64" step="4" value="32">
                                  </label>

                                  <label>
                                    Snap subdivisions <span id="snapDivOut">4</span>
                                    <input id="snapDiv" type="range" min="1" max="8" step="1" value="4">
                                  </label>

                                  <label>
                                    Corridor width
                                    <input id="corridorWidth" type="range" min="12" max="96" step="4" value="48">
                                  </label>

                                  <label>
                                    Wall width
                                    <input id="wallWidth" type="range" min="2" max="14" step="1" value="6">
                                  </label>
                                  <label>
                                    Wall color
                                    <input id="wallColor" type="color" value="#1f2933">
                                  </label>

                                  <label>
                                    Interior floor color
                                    <input id="floorColor" type="color" value="#ffffff">
                                  </label>

                                  <label>
                                    Background color
                                    <input id="backgroundColor" type="color" value="#f8f7f4">
                                  </label>

                                  <label class="inline">
                                    <span>Transparent background</span>
                                    <input id="transparentBg" type="checkbox">
                                  </label>


                                  <div class="shadowRow">
                                    <label class="inline">
                                      <span>Interior shadow</span>
                                      <input id="shadowOn" type="checkbox" checked>
                                    </label>

                                    <div class="puckWrap" title="Drag the dot to set shadow direction + length">
                                      <canvas id="shadowPuck" width="120" height="120"></canvas>
                                      <div class="puckLabel">direction</div>
                                    </div>
                                  </div>

                                  <label>
                                    Shadow opacity
                                    <input id="shadowOpacity" type="range" min="0" max="0.9" step="0.01" value="0.34">
                                  </label>
                                  <label>
                                    Shadow color
                                    <input id="shadowColor" type="color" value="#000000">
                                  </label>


                                  <label class="inline">
                                    <span>Cross hatching (outside)</span>
                                    <input id="hatchOn" type="checkbox" checked>
                                  </label>

                                  <label>
                                    Hatch density
                                    <input id="hatchDensity" type="range" min="0.25" max="30" step="0.25" value="14">
                                  </label>

                                  <label>
                                    Hatch opacity
                                    <input id="hatchOpacity" type="range" min="0" max="0.7" step="0.01" value="0.22">
                                  </label>
                                  <label>
                                    Hatch color
                                    <input id="hatchColor" type="color" value="#1f2933">
                                  </label>


                                  <label>
                                    Hatch depth
                                    <input id="hatchDepth" type="range" min="0" max="34" step="1" value="12">
                                  </label>

                                  <label>
                                    Snap strength
                                    <input id="snapStrength" type="range" min="0" max="1" step="0.05" value="0.95">
                                  </label>

                                  <label class="inline">
                                    <span>Prop grid snap (move/rotate)</span>
                                    <input id="propSnapToggle" type="checkbox" checked>
                                  </label>

                                  <label class="inline">
                                    <span>Show text in preview</span>
                                    <input id="showTextPreview" type="checkbox" checked>
                                  </label>
                                  <label class="inline">
                                    <span>Include text in export</span>
                                    <input id="showTextExport" type="checkbox" checked>
                                  </label>

              </div>

              <div id="textStylePanel" class="controls hidden">
                <div class="assetsIntro">Text settings (selected label)</div>
                <label>
                  Text
                  <input id="textContentInput" type="text" placeholder="Label">
                </label>
                <label>
                  Font
                  <select id="textFontFamily">
                    <option value="Minecraft Five">Minecraft Five</option>
                    <option value="system-ui">Sans</option>
                    <option value="serif">Serif</option>
                    <option value="monospace">Monospace</option>
                  </select>
                </label>
                <label>
                  Google Font
                  <div class="fontLoadRow">
                    <input id="googleFontFamilyInput" type="text" placeholder="Search / enter family (e.g. Inter, Cinzel)" list="googleFontSuggestions" autocomplete="off">
                    <button id="btnLoadGoogleFont" type="button" class="ghostBtn">Load</button>
                  </div>
                  <div id="googleFontStatus" class="fontStatus" aria-live="polite"></div>
                  <div id="googleFontRecent" class="fontRecent" aria-label="Recent Google fonts"></div>
                  <datalist id="googleFontSuggestions">
                    <option value="Inter"></option>
                    <option value="Roboto"></option>
                    <option value="Open Sans"></option>
                    <option value="Montserrat"></option>
                    <option value="Poppins"></option>
                    <option value="Lato"></option>
                    <option value="Nunito"></option>
                    <option value="Oswald"></option>
                    <option value="Raleway"></option>
                    <option value="Playfair Display"></option>
                    <option value="Merriweather"></option>
                    <option value="Lora"></option>
                    <option value="Cinzel"></option>
                    <option value="Cormorant Garamond"></option>
                    <option value="Bebas Neue"></option>
                    <option value="Orbitron"></option>
                    <option value="Rubik"></option>
                    <option value="DM Serif Display"></option>
                    <option value="Press Start 2P"></option>
                    <option value="MedievalSharp"></option>
                    <option value="Uncial Antiqua"></option>
                    <option value="JetBrains Mono"></option>
                    <option value="Fira Sans"></option>
                    <option value="Tektur"></option>
                  </datalist>
                </label>
                <label>
                  Size
                  <input id="textFontSize" type="range" min="8" max="144" step="1" value="20">
                  <div class="pdfRangeValue"><span id="textFontSizeOut">20</span> px</div>
                </label>
                <label>
                  Color
                  <input id="textColorInput" type="color" value="#1f2933">
                </label>
              </div>

              <details class="subFold">
                                <summary>Help</summary>
                                <div class="hint">
                                <div><b>Select</b>: move props by dragging; drag the blue handle to rotate (toggle prop grid snap on/off)</div>
                                <div><b>Rectangle</b>: drag to create a snapped rectangle</div>
                                <div><b>Path</b>: tap to add points, double-tap to end</div>
                                <div><b>Free</b>: draw with one finger, lift to finish</div>
                                <div><b>Polygon</b>: tap+drag to create a regular polygon; use the Polygon sides slider (3–12), then drag handles to resize/rotate; tap center to move</div>
                                <div><b>Erase</b>: drag a snapped box on the sub-grid to cut out volume cells (finer than the visible grid)</div>
                                <div><b>Erase</b> toggle: turns the current drawing tool into subtract mode (Rectangle / Path / Free / Polygon)</div>
                        <div><b>Mouse/Trackpad</b>: wheel pan • pinch/ctrl+wheel zoom (cursor-centered) • right/middle drag pan</div>
                                <div><b>Touch</b>: two-finger drag pan • pinch zoom</div>
                                </div>
                              </details>
            </section>

            <section id="assetsPage" class="panelPage hidden" data-panel-page="assets" role="tabpanel" aria-hidden="true">
              <div class="assetsIntro">Load a folder of PNG props (doors, beds, fireplaces, etc.) and drag them onto the map.</div>
              <div class="propsBlock">
                                  <div class="propsToolbar">
                                    <button id="btnPropsPick" type="button" title="Pick a folder of PNG prop icons/thumbnails">Set Asset Folder…</button>
                                    <button id="btnPropsDefaults" type="button" class="ghostBtn" title="Reload bundled props">Defaults</button>
                                    <button id="btnPropsClear" type="button" title="Clear imported prop previews">Clear Imported</button>
                                  </div>
                                  <input id="propsFolderInput" type="file" accept=".png,.svg,.webp,.jpg,.jpeg,image/*" webkitdirectory multiple hidden>
                                  <div class="propsHint">Prototype shelf for imported prop PNGs (doors, beds, fireplaces, etc.). Placement tools can hook into this next.</div>
                                  <div id="propsShelf" class="propsShelf empty" aria-live="polite">
                                    <div class="propsEmpty">No props loaded yet</div>
                                  </div>
                                </div>
              <div class="assetsHint">Tip: drag from the shelf onto the canvas. Tap a tile to arm one-click placement (handy on touch).</div>
            </section>
          </div>
        </div>
      </div>

      <button id="drawerPeekTab" class="drawerPeekTab" type="button" title="Open inspector" aria-label="Open inspector">☰</button>
    </aside>
  </div>



  <div id="textEditOverlay" class="textEditOverlay hidden" aria-hidden="true">
    <textarea id="textCanvasEditor" class="textCanvasEditor" rows="1" spellcheck="false" placeholder="Label"></textarea>
    <div class="textCanvasEditorHint">Enter to save · Esc to cancel</div>
  </div>

  <input id="fileLoadMap" type="file" accept="application/json,.json" style="display:none" />


  <div id="pdfExportModal" class="pdfModalOverlay hidden" aria-hidden="true">
    <div class="pdfModalScrim" data-pdf-modal-close></div>
    <div class="pdfModalCard" role="dialog" aria-modal="true" aria-labelledby="pdfExportTitle">
      <div class="pdfModalHeader">
        <div>
          <div class="pdfModalEyebrow">Export</div>
          <h2 id="pdfExportTitle">PDF Export</h2>
        </div>
        <button id="btnPdfModalClose" type="button" class="drawerMiniBtn" title="Close">✕</button>
      </div>

      <div class="pdfModalBody">
        <div class="pdfSectionCard">
          <div class="pdfSectionTitle">Layout</div>
          <div class="pdfFormGrid">
            <label>
              Mode
              <select id="pdfMode">
                <option value="tiled">Tiled (poster / battlemat)</option>
                <option value="single">Single page (fit)</option>
              </select>
            </label>
            <label>
              Paper
              <select id="pdfPaper">
                <option value="LETTER">Letter</option>
                <option value="A4">A4</option>
              </select>
            </label>
            <label>
              Orientation
              <select id="pdfOrientation">
                <option value="auto">Auto</option>
                <option value="portrait">Portrait</option>
                <option value="landscape">Landscape</option>
              </select>
            </label>
            <label>
              Content area
              <select id="pdfSource">
                <option value="map">Map bounds</option>
                <option value="viewport">Current viewport</option>
              </select>
            </label>
            <label>
              Padding (grid squares)
              <input id="pdfPaddingSquares" type="number" min="0" max="100" step="1" value="1">
            </label>
            <label>
              Margins (inches)
              <input id="pdfMarginIn" type="number" min="0" max="2" step="0.05" value="0.25">
            </label>
            <label class="pdfFieldWide">
              Raster DPI
              <input id="pdfRasterDpi" type="range" min="96" max="600" step="4" value="220">
              <div class="pdfRangeValue"><span id="pdfRasterDpiOut">220</span> dpi</div>
            </label>
          </div>
        </div>

        <div class="pdfSectionCard" id="pdfTiledSection">
          <div class="pdfSectionTitle">Tiled print settings</div>
          <div class="pdfFormGrid">
            <label>
              Square print size (inches per grid square)
              <input id="pdfSquareSizeIn" type="number" min="0.1" max="5" step="0.05" value="1.0">
            </label>
            <label>
              Tile overlap (grid squares)
              <input id="pdfOverlapSquares" type="number" min="0" max="20" step="1" value="0">
            </label>
            <label class="inline pdfFieldWide">
              <span>Page labels (A1, A2, B1…)</span>
              <input id="pdfLabels" type="checkbox" checked>
            </label>
            <label class="inline pdfFieldWide">
              <span>Trim marks</span>
              <input id="pdfTrimMarks" type="checkbox" checked>
            </label>
            <label class="inline pdfFieldWide">
              <span>Assembly overview page</span>
              <input id="pdfOverview" type="checkbox" checked>
            </label>
            <label class="inline pdfFieldWide">
              <span>Include effectively empty pages</span>
              <input id="pdfIncludeEmptyTiles" type="checkbox">
            </label>
          </div>
          <div class="pdfHint">Off by default: tiles with no visible map interior and no placed props are skipped.</div>
        </div>

        <div class="pdfExportSummary" id="pdfExportSummary">Ready to export.</div>
      </div>

      <div class="pdfModalFooter">
        <button id="btnPdfCancel" type="button">Cancel</button>
        <button id="btnPdfConfirm" type="button" class="primary">Export PDF</button>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const STORAGE_KEY = 'dungeonSketch.alphaBannerDismissed.v1';
      const banner = document.getElementById('alphaBanner');
      const closeBtn = document.getElementById('btnAlphaBannerClose');
      if (!banner || !closeBtn) return;
      try {
        if (localStorage.getItem(STORAGE_KEY) === '1') banner.hidden = true;
      } catch (e) {}
      closeBtn.addEventListener('click', function(){
        banner.hidden = true;
        try { localStorage.setItem(STORAGE_KEY, '1'); } catch (e) {}
      });
    })();
  </script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
  <script type="module" src="main.js"></script>
</body>
</html>
